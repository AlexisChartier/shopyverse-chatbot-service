apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: monitoring
data:
  chatbot-alerts.yml: |
    groups:
      - name: chatbot-service
        interval: 30s
        rules:
          # Latency alerts
          - alert: HighLatencyP95
            expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High P95 latency detected"
              description: "P95 latency is {{ $value }}s for chatbot service"

          - alert: CriticalLatencyP99
            expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) > 5
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Critical P99 latency detected"
              description: "P99 latency is {{ $value }}s for chatbot service"

          # Error rate alerts
          - alert: HighErrorRate
            expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High 5xx error rate"
              description: "5xx error rate is {{ $value }} requests/sec"

          - alert: CriticalErrorRate
            expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Critical 5xx error rate"
              description: "5xx error rate is {{ $value }} requests/sec"

          - alert: High4xxErrorRate
            expr: rate(http_requests_total{status=~"4.."}[5m]) > 0.2
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High 4xx error rate"
              description: "4xx error rate is {{ $value }} requests/sec"

          # Resource saturation alerts
          - alert: HighCPUUsage
            expr: rate(container_cpu_usage_seconds_total{pod=~"chatbot-service-.*"}[5m]) > 0.8
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage"
              description: "Pod {{ $labels.pod }} CPU usage is {{ $value }}"

          - alert: HighMemoryUsage
            expr: container_memory_usage_bytes{pod=~"chatbot-service-.*"} / container_spec_memory_limit_bytes > 0.85
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage"
              description: "Pod {{ $labels.pod }} memory usage is {{ $value | humanizePercentage }}"

          # Pod health alerts
          - alert: PodCrashLooping
            expr: rate(kube_pod_container_status_restarts_total{pod=~"chatbot-service-.*"}[15m]) > 0.1
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Pod is crash looping"
              description: "Pod {{ $labels.pod }} is restarting frequently"

          - alert: PodNotReady
            expr: kube_pod_status_ready{pod=~"chatbot-service-.*", condition="false"} == 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Pod not ready"
              description: "Pod {{ $labels.pod }} is not ready"

          # Database connection pool alerts
          - alert: DatabaseConnectionPoolExhausted
            expr: chatbot_db_pool_available_connections == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Database connection pool exhausted"
              description: "No available database connections in the pool"

          # Qdrant availability
          - alert: QdrantServiceDown
            expr: up{job="qdrant"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Qdrant service is down"
              description: "Qdrant service at {{ $labels.instance }} is not responding"

          # HuggingFace API errors
          - alert: HighHuggingFaceAPIErrors
            expr: rate(huggingface_api_errors_total[5m]) > 0.01
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High HuggingFace API error rate"
              description: "HuggingFace API error rate is {{ $value }} errors/sec"

          # Deployment replica mismatch
          - alert: DeploymentReplicasMismatch
            expr: kube_deployment_spec_replicas{deployment=~"chatbot-service.*"} != kube_deployment_status_replicas_available{deployment=~"chatbot-service.*"}
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Deployment replicas mismatch"
              description: "Deployment {{ $labels.deployment }} has spec replicas {{ $value }} but only some are available"
