name: CD Pipeline

on:
  push:
    branches: [main]
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl
        env:
          K8S_CONTEXT: ${{ secrets.K8S_CONTEXT }}
          KUBECONFIG_B64: ${{ secrets.K8S_KUBECONFIG_B64 }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_B64" | base64 -d > $HOME/.kube/config
          kubectl config use-context "$K8S_CONTEXT"
          kubectl version --client

      - name: Create namespace
        run: kubectl create namespace chatbot-dev --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Kubernetes secrets
        env:
          HF_TOKEN: ${{ secrets.HF_ACCESS_TOKEN }}
        run: |
          kubectl create secret generic chatbot-service-secrets \
            --from-literal=hf-access-token="${HF_TOKEN}" \
            --from-literal=api-key="dev-api-key-$(date +%s)" \
            --from-literal=db-password="chatbot" \
            -n chatbot-dev \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Docker registry secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --docker-email=${{ github.actor }}@users.noreply.github.com \
            -n chatbot-dev \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy using Helm
        env:
          ENVIRONMENT: dev
          IMAGE_TAG: latest
          REPLICAS: 1
        run: |
          helm upgrade --install chatbot-service ./helm/chatbot-service \
            --namespace chatbot-dev \
            --values ./helm/values-dev.yaml \
            --set image.tag=$IMAGE_TAG \
            --set replicaCount=$REPLICAS \
            --wait --timeout 3m || true

      - name: Debug deployment status
        if: always()
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment -n chatbot-dev
          echo -e "\n=== Pod Status ==="
          kubectl get pods -n chatbot-dev -l app=chatbot-service
          echo -e "\n=== Pod Events ==="
          kubectl get events -n chatbot-dev --sort-by='.lastTimestamp' | tail -20
          echo -e "\n=== Pod Logs (if any) ==="
          kubectl logs -n chatbot-dev -l app=chatbot-service --tail=50 || echo "No logs available"
          echo -e "\n=== Pod Description ==="
          kubectl describe pods -n chatbot-dev -l app=chatbot-service || echo "No pods found"

      - name: Force cleanup old pods if stuck
        if: always()
        run: |
          # Delete old pods that are stuck terminating
          kubectl delete pods -n chatbot-dev -l app=chatbot-service --field-selector status.phase=Terminating --grace-period=0 --force || true

      - name: Run health check
        run: |
          kubectl rollout status deployment/chatbot-service -n chatbot-dev --timeout=2m || true
          kubectl get pods -n chatbot-dev -l app=chatbot-service
          
          # Check if at least one pod is running
          RUNNING_PODS=$(kubectl get pods -n chatbot-dev -l app=chatbot-service --field-selector=status.phase=Running -o jsonpath='{.items}' | jq '. | length')
          if [ "$RUNNING_PODS" -gt 0 ]; then
            echo "âœ… Deployment successful: $RUNNING_PODS pod(s) running"
            exit 0
          else
            echo "âŒ No running pods found"
            exit 1
          fi

      - name: Slack notification on success
        if: success() && vars.SLACK_WEBHOOK_DEV != ''
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_DEV }}
          payload: |
            {
              "text": "âœ… Deployment to DEV successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*DEV Deployment Success*\nCommit: `${{ github.sha }}`\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }
        continue-on-error: true

      - name: Slack notification on failure
        if: failure() && vars.SLACK_WEBHOOK_DEV != ''
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_DEV }}
          payload: |
            {
              "text": "âŒ Deployment to DEV failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*DEV Deployment Failed*\nCommit: `${{ github.sha }}`\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }
        continue-on-error: true

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl
        env:
          K8S_CONTEXT: ${{ secrets.K8S_CONTEXT }}
          KUBECONFIG_B64: ${{ secrets.K8S_KUBECONFIG_B64 }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_B64" | base64 -d > $HOME/.kube/config
          kubectl config use-context "$K8S_CONTEXT"

      - name: Create namespace
        run: kubectl create namespace chatbot-staging --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy using Helm with canary strategy
        env:
          ENVIRONMENT: staging
          IMAGE_TAG: ${{ github.sha }}
          REPLICAS: 2
        run: |
          helm upgrade --install chatbot-service ./helm/chatbot-service \
            --namespace chatbot-staging \
            --values ./helm/values-staging.yaml \
            --set image.tag=$IMAGE_TAG \
            --set replicaCount=$REPLICAS \
            --set deploymentStrategy=canary \
            --wait --timeout 10m

      - name: Verify deployment health
        run: |
          kubectl rollout status deployment/chatbot-service -n chatbot-staging --timeout=10m
          # Check pod ready status
          kubectl get pods -n chatbot-staging -l app=chatbot-service
          # Simple health check
          POD=$(kubectl get pods -n chatbot-staging -l app=chatbot-service -o jsonpath='{.items[0].metadata.name}')
          kubectl port-forward -n chatbot-staging pod/$POD 3001:3001 &
          sleep 3
          curl -s http://localhost:3001/metrics || echo "Health check attempted"

      - name: Run smoke tests against staging
        run: |
          npm ci
          npm run test:e2e || echo "E2E tests skipped for staging"

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl
        env:
          K8S_CONTEXT: ${{ secrets.K8S_CONTEXT }}
          KUBECONFIG_B64: ${{ secrets.K8S_KUBECONFIG_B64 }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_B64" | base64 -d > $HOME/.kube/config
          kubectl config use-context "$K8S_CONTEXT"

      - name: Create namespace
        run: kubectl create namespace chatbot-prod --dry-run=client -o yaml | kubectl apply -f -

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Deploy using Helm with blue-green strategy
        env:
          ENVIRONMENT: prod
          IMAGE_TAG: ${{ steps.version.outputs.VERSION }}
          REPLICAS: 3
        run: |
          helm upgrade --install chatbot-service ./helm/chatbot-service \
            --namespace chatbot-prod \
            --values ./helm/values-prod.yaml \
            --set image.tag=$IMAGE_TAG \
            --set replicaCount=$REPLICAS \
            --set deploymentStrategy=blue-green \
            --wait --timeout 15m

      - name: Verify production deployment
        run: |
          kubectl rollout status deployment/chatbot-service -n chatbot-prod --timeout=15m
          kubectl get pods -n chatbot-prod -l app=chatbot-service -o wide
          # Verify all replicas are running
          kubectl get deployment chatbot-service -n chatbot-prod

      - name: Run production smoke tests
        env:
          API_URL: https://chatbot.shopyverse.prod/api/v1
          API_KEY: ${{ secrets.PROD_API_KEY }}
        run: |
          npm ci
          npm run test:e2e || true

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          release_name: Release ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false

      - name: Slack notification on production deployment
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_PROD }}
          payload: |
            {
              "text": "ðŸš€ Production Deployment Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*PRODUCTION Deployment Success*\nVersion: `${{ steps.version.outputs.VERSION }}`\nAuthor: ${{ github.actor }}\nTime: <!date^${{ github.event.repository.pushed_at }}^{date_num} {time_secs}|${{ github.event.repository.pushed_at }}>"
                  }
                }
              ]
            }

      - name: Slack notification on production failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_PROD }}
          payload: |
            {
              "text": "ðŸ”´ Production Deployment Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*PRODUCTION Deployment Failed*\nVersion: `${{ steps.version.outputs.VERSION }}`\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }
